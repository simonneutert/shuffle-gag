name: GetEpisode

on:
  schedule:
    - cron: "0 11 * * 3"
    - cron: "0 18 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CI_COMMIT_MESSAGE: "Getting newest episode via GitHub Actions"
      CI_COMMIT_AUTHOR: "Mr Crawlmuch"
    steps:
      - uses: actions/checkout@v3

      - name: Setup Babashka
        uses: turtlequeue/setup-babashka@v1.5.2
        with:
          babashka-version: 1.3.186

      - name: Get newest episode from Apple Podcasts
        run: |
          bb -f get-episode-apple-podcasts.clj
          cat newest-episode-apple-podcasts.json

      - name: Get newest episode from Spotify
        env: # Or as an environment variable
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        run: |
          bb -f get-episode-spotify.clj
          cat newest-episode-spotify.json

      - name: Join newest episodes
        run: |
          bb -f join-episodes.clj
          tail data.json

      # Commit and push all changed files.
      - name: GIT Commit Add Episode
        run: |
          git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
          git config --global user.email "username@users.noreply.github.com"
          git commit -a -m "${{ env.CI_COMMIT_MESSAGE }}"
          git push
